name: One+ Build Susf4Ksu

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      ROOT_DIR: build_directory
      REPOS: |
        https://gitlab.com/simonpunk/susfs4ksu.git
        https://github.com/WildPlusKernel/kernel_patches.git
      KERNEL_MANIFEST_URL: https://github.com/OnePlusOSS/kernel_manifest.git
      BRANCH: oneplus/sm8650
      XML_FILE: oneplus_13r.xml

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Ensure build directory exists
      run: mkdir -p /home/runner/work/BOuti/BOuti/builds/${{ env.ROOT_DIR }}

    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y repo git curl zip

    - name: Clone repositories
      run: |
        IFS=$'\n'
        for repo in ${{ env.REPOS }}; do
          git clone "$repo" || { echo "Failed to clone $repo"; exit 1; }
        done
        unset IFS

    - name: Setup kernel platform
      working-directory: /home/runner/work/BOuti/BOuti/builds/${{ env.ROOT_DIR }}
      run: |
        mkdir -p kernel_platform/oneplus13r_v
        cd kernel_platform/oneplus13r_v
        retry_count=0
        max_retries=3
        until [ $retry_count -ge $max_retries ]; do
          repo init -u ${{ env.KERNEL_MANIFEST_URL }} -b ${{ env.BRANCH }} -m ${{ env.XML_FILE }} --depth=1 && break || retry_count=$((retry_count+1)) && sleep 10
        done
        if [ $retry_count -eq $max_retries ]; then
          echo "Failed to initialize repo after $max_retries attempts."
          exit 1
        fi
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags || { echo "Failed to sync repo"; exit 1; }

    - name: Setup KernelSU
      working-directory: /home/runner/work/BOuti/BOuti/builds/${{ env.ROOT_DIR }}/kernel_platform/oneplus13r_v/kernel_platform
      run: |
        curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -s next
        git submodule update --init --recursive
        cd KernelSU-Next/kernel
        KSU_VERSION=$(expr $(/usr/bin/git rev-list --count HEAD) "+" 10200)
        echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
        sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile

    - name: Setup SUSFS
      working-directory: /home/runner/work/BOuti/BOuti/builds/${{ env.ROOT_DIR }}/kernel_platform/oneplus13r_v/kernel_platform
      run: |
        set -euxo pipefail
        cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch ./common/
        cp kernel_patches/next/0001-kernel-patch-susfs-v1.5.5-to-KernelSU-Next-v1.0.5.patch ./KernelSU-Next/
        cp kernel_patches/next/syscall_hooks.patch ./common/
        cp susfs4ksu/kernel_patches/fs/* ./common/fs/
        cp susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
        cd ./KernelSU-Next
        patch -p1 < 0001-kernel-patch-susfs-v1.5.5-to-KernelSU-Next-v1.0.5.patch || true
        cd ../common
        patch -p1 < 50_add_susfs_in_gki-android14-6.1.patch || true
        if [ -f kernel_patches/69_hide_stuff.patch ]; then
          cp kernel_patches/69_hide_stuff.patch ./
          patch -p1 -F 3 < 69_hide_stuff.patch || true
        fi
        patch -p1 -F 3 < syscall_hooks.patch || true

    - name: Configure Kernel
      working-directory: /home/runner/work/BOuti/BOuti/builds/${{ env.ROOT_DIR }}/kernel_platform/oneplus13r_v/kernel_platform
      run: |
        set -e
        CONFIGS=(
          "CONFIG_KSU=y"
          "CONFIG_KSU_WITH_KPROBES=n"
          "CONFIG_KSU_SUSFS=y"
          "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y"
          "CONFIG_KSU_SUSFS_SUS_PATH=y"
          "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
          "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y"
          "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y"
          "CONFIG_KSU_SUS_KSTAT=y"
          "CONFIG_KSU_SUS_OVERLAYFS=n"
          "CONFIG_KSU_SUS_TRY_UMOUNT=y"
          "CONFIG_KSU_SUS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y"
          "CONFIG_KSU_SUS_SPOOF_UNAME=y"
          "CONFIG_KSU_SUS_ENABLE_LOG=y"
          "CONFIG_KSU_SUS_HIDE_KSU_SUS_SYMBOLS=y"
          "CONFIG_KSU_SUS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"
          "CONFIG_KSU_SUS_OPEN_REDIRECT=y"
          "CONFIG_KSU_SU=n"
          "CONFIG_TMPFS_XATTR=y"
          "CONFIG_TMPFS_POSIX_ACL=y"
          "CONFIG_IP_NF_TARGET_TTL=y"
          "CONFIG_IP6_NF_TARGET_HL=y"
          "CONFIG_IP6_NF_MATCH_HL=y"
          "CONFIG_SCHED_CLASS_EXT=y"
          "CONFIG_SMP=y"
          "CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y"
          "CONFIG_MSM_PERFORMANCE=y"
          "CONFIG_NO_HZ_IDLE=y"
          "CONFIG_PM_SLEEP_SMP=y"
        )
        for CONFIG in "${CONFIGS[@]}"; do
          echo "$CONFIG" >> ./common/arch/arm64/configs/gki_defconfig
        done
        sed -i '2s/check_defconfig//' ./common/build.config.gki

    - name: Run sed Commands
      working-directory: /home/runner/work/BOuti/BOuti/builds/${{ env.ROOT_DIR }}/kernel_platform/oneplus13r_v/kernel_platform
      run: |
        set -e
        sed -i 's/-dirty//' ./common/scripts/setlocalversion || true
        sed -i 's/-dirty//' ./msm-kernel/scripts/setlocalversion || true
        sed -i 's/-dirty//' ./external/dtc/scripts/setlocalversion || true
        sed -i 's/-dirty//' ./build/kernel/kleaf/workspace_status_stamp.py || echo "No workspace_status_stamp.py!"

    - name: Build Kernel
      working-directory: /home/runner/work/BOuti/BOuti/builds/${{ env.ROOT_DIR }}/kernel_platform/oneplus13r_v/
      run: |
        cd kernel_platform
        mkdir out
        export PATH="/usr/lib/ccache:$PATH"
        ./build_with_bazel.py \
          -t pineapple \
          gki \
          --jobs=$(nproc --all) \
          --verbose_failures \
          --config=stamp \
          --user_kmi_symbol_lists=//msm-kernel:android/abi_gki_aarch64_qcom \
          --ignore_missing_projects \
          --lto=full \
          -o "$(pwd)/out" || { echo "Bazel build failed"; exit 1; }

    - name: Create ZIP Package
      working-directory: /home/runner/work/BOuti/BOuti/builds/${{ env.ROOT_DIR }}
      run: |
        if [ ! -f kernel_platform/oneplus13r_v/kernel_platform/out/dist/Image ]; then
          echo "❌ Kernel image not found"
          exit 1
        fi
        cp kernel_platform/oneplus13r_v/kernel_platform/out/dist/Image AnyKernel3/Image || {
          echo "❌ Failed to copy kernel image"
          exit 1
        }
        cd AnyKernel3
        ZIP_NAME="OP13r-KSU-${{ env.KSUVER }}.zip"
        zip -r "../$ZIP_NAME" ./* || {
          echo "❌ Failed to create zip file"
          exit 1
        }
        ls -lh "../$ZIP_NAME"
        echo "zip_name=$ZIP_NAME" >> $GITHUB_ENV

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ env.ROOT_DIR }}
        path: /home/runner/work/BOuti/BOuti/builds/${{ env.ROOT_DIR }}/*.zip
